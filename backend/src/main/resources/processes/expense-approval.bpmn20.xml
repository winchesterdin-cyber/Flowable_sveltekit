<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="expense-approval" name="Expense Approval" isExecutable="true">
        <documentation>Expense approval workflow with threshold-based routing</documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Expense Submitted">
            <documentation>Employee submits expense for approval</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="checkAmount"/>

        <!-- Gateway: Check Amount Threshold -->
        <exclusiveGateway id="checkAmount" name="Check Amount"/>

        <!-- Low Amount Path: Direct to Supervisor -->
        <sequenceFlow id="flowLow" sourceRef="checkAmount" targetRef="supervisorApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${amount <= 500}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- High Amount Path: Supervisor then Executive -->
        <sequenceFlow id="flowHigh" sourceRef="checkAmount" targetRef="supervisorReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${amount > 500}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Supervisor Approval (for low amounts) -->
        <userTask id="supervisorApproval" name="Approve Expense"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="expense-approval-form">
            <documentation>Review and approve expense request (Amount: $${amount})</documentation>
        </userTask>

        <sequenceFlow id="flow2" sourceRef="supervisorApproval" targetRef="checkSupervisorDecision"/>

        <!-- Gateway: Check Supervisor Decision -->
        <exclusiveGateway id="checkSupervisorDecision" name="Approved?"/>

        <sequenceFlow id="flowApproved" sourceRef="checkSupervisorDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRejected" sourceRef="checkSupervisorDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Supervisor Review (for high amounts) -->
        <userTask id="supervisorReview" name="Review High-Value Expense"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="expense-review-form">
            <documentation>Review high-value expense and recommend for executive approval (Amount: $${amount})</documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="supervisorReview" targetRef="checkReviewDecision"/>

        <!-- Gateway: Check Review Decision -->
        <exclusiveGateway id="checkReviewDecision" name="Recommend?"/>

        <sequenceFlow id="flowRecommend" sourceRef="checkReviewDecision" targetRef="executiveApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowReviewReject" sourceRef="checkReviewDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Executive Approval -->
        <userTask id="executiveApproval" name="Executive Approval Required"
                  flowable:candidateGroups="executives"
                  flowable:formKey="expense-approval-form">
            <documentation>Final approval for high-value expense (Amount: $${amount})</documentation>
        </userTask>

        <sequenceFlow id="flow4" sourceRef="executiveApproval" targetRef="checkExecutiveDecision"/>

        <!-- Gateway: Check Executive Decision -->
        <exclusiveGateway id="checkExecutiveDecision" name="Executive Approved?"/>

        <sequenceFlow id="flowExecApproved" sourceRef="checkExecutiveDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExecRejected" sourceRef="checkExecutiveDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- End Events -->
        <endEvent id="endApproved" name="Expense Approved">
            <documentation>Expense has been approved</documentation>
        </endEvent>

        <endEvent id="endRejected" name="Expense Rejected">
            <documentation>Expense has been rejected</documentation>
        </endEvent>

    </process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_expense-approval">
        <bpmndi:BPMNPlane id="BPMNPlane_expense-approval" bpmnElement="expense-approval">
            <!-- Start Event -->
            <bpmndi:BPMNShape id="startEvent_di" bpmnElement="startEvent">
                <dc:Bounds x="100" y="200" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="75" y="243" width="86" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Check Amount Gateway -->
            <bpmndi:BPMNShape id="checkAmount_di" bpmnElement="checkAmount" isMarkerVisible="true">
                <dc:Bounds x="195" y="193" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="182" y="250" width="76" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Supervisor Approval (Low Amount Path) -->
            <bpmndi:BPMNShape id="supervisorApproval_di" bpmnElement="supervisorApproval">
                <dc:Bounds x="320" y="100" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Check Supervisor Decision Gateway -->
            <bpmndi:BPMNShape id="checkSupervisorDecision_di" bpmnElement="checkSupervisorDecision" isMarkerVisible="true">
                <dc:Bounds x="485" y="115" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="480" y="85" width="60" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Supervisor Review (High Amount Path) -->
            <bpmndi:BPMNShape id="supervisorReview_di" bpmnElement="supervisorReview">
                <dc:Bounds x="320" y="280" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Check Review Decision Gateway -->
            <bpmndi:BPMNShape id="checkReviewDecision_di" bpmnElement="checkReviewDecision" isMarkerVisible="true">
                <dc:Bounds x="485" y="295" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="476" y="352" width="68" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Executive Approval -->
            <bpmndi:BPMNShape id="executiveApproval_di" bpmnElement="executiveApproval">
                <dc:Bounds x="600" y="280" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Check Executive Decision Gateway -->
            <bpmndi:BPMNShape id="checkExecutiveDecision_di" bpmnElement="checkExecutiveDecision" isMarkerVisible="true">
                <dc:Bounds x="765" y="295" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="745" y="352" width="90" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- End Approved -->
            <bpmndi:BPMNShape id="endApproved_di" bpmnElement="endApproved">
                <dc:Bounds x="900" y="200" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="875" y="243" width="86" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- End Rejected -->
            <bpmndi:BPMNShape id="endRejected_di" bpmnElement="endRejected">
                <dc:Bounds x="900" y="400" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="875" y="443" width="86" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Sequence Flows -->
            <bpmndi:BPMNEdge id="flow1_di" bpmnElement="flow1">
                <di:waypoint x="136" y="218"/>
                <di:waypoint x="195" y="218"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowLow_di" bpmnElement="flowLow">
                <di:waypoint x="220" y="193"/>
                <di:waypoint x="220" y="140"/>
                <di:waypoint x="320" y="140"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="235" y="120" width="60" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowHigh_di" bpmnElement="flowHigh">
                <di:waypoint x="220" y="243"/>
                <di:waypoint x="220" y="320"/>
                <di:waypoint x="320" y="320"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="235" y="300" width="55" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow2_di" bpmnElement="flow2">
                <di:waypoint x="420" y="140"/>
                <di:waypoint x="485" y="140"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowApproved_di" bpmnElement="flowApproved">
                <di:waypoint x="535" y="140"/>
                <di:waypoint x="918" y="140"/>
                <di:waypoint x="918" y="200"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="700" y="120" width="50" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowRejected_di" bpmnElement="flowRejected">
                <di:waypoint x="510" y="165"/>
                <di:waypoint x="510" y="418"/>
                <di:waypoint x="900" y="418"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="660" y="400" width="48" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow3_di" bpmnElement="flow3">
                <di:waypoint x="420" y="320"/>
                <di:waypoint x="485" y="320"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowRecommend_di" bpmnElement="flowRecommend">
                <di:waypoint x="535" y="320"/>
                <di:waypoint x="600" y="320"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="545" y="302" width="60" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowReviewReject_di" bpmnElement="flowReviewReject">
                <di:waypoint x="510" y="345"/>
                <di:waypoint x="510" y="418"/>
                <di:waypoint x="900" y="418"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="560" y="378" width="48" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow4_di" bpmnElement="flow4">
                <di:waypoint x="700" y="320"/>
                <di:waypoint x="765" y="320"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowExecApproved_di" bpmnElement="flowExecApproved">
                <di:waypoint x="790" y="295"/>
                <di:waypoint x="790" y="218"/>
                <di:waypoint x="900" y="218"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="820" y="200" width="50" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowExecRejected_di" bpmnElement="flowExecRejected">
                <di:waypoint x="790" y="345"/>
                <di:waypoint x="790" y="418"/>
                <di:waypoint x="900" y="418"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="820" y="400" width="48" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</definitions>
