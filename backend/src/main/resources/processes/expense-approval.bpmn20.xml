<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="expense-approval" name="Expense Approval" isExecutable="true">
        <documentation>Expense approval workflow with threshold-based routing</documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Expense Submitted">
            <documentation>Employee submits expense for approval</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="checkAmount"/>

        <!-- Gateway: Check Amount Threshold -->
        <exclusiveGateway id="checkAmount" name="Check Amount"/>

        <!-- Low Amount Path: Direct to Supervisor -->
        <sequenceFlow id="flowLow" sourceRef="checkAmount" targetRef="supervisorApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${amount <= 500}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- High Amount Path: Supervisor then Executive -->
        <sequenceFlow id="flowHigh" sourceRef="checkAmount" targetRef="supervisorReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${amount > 500}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Supervisor Approval (for low amounts) -->
        <userTask id="supervisorApproval" name="Approve Expense"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="expense-approval-form">
            <documentation>Review and approve expense request (Amount: $${amount})</documentation>
        </userTask>

        <sequenceFlow id="flow2" sourceRef="supervisorApproval" targetRef="checkSupervisorDecision"/>

        <!-- Gateway: Check Supervisor Decision -->
        <exclusiveGateway id="checkSupervisorDecision" name="Approved?"/>

        <sequenceFlow id="flowApproved" sourceRef="checkSupervisorDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowRejected" sourceRef="checkSupervisorDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Supervisor Review (for high amounts) -->
        <userTask id="supervisorReview" name="Review High-Value Expense"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="expense-review-form">
            <documentation>Review high-value expense and recommend for executive approval (Amount: $${amount})</documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="supervisorReview" targetRef="checkReviewDecision"/>

        <!-- Gateway: Check Review Decision -->
        <exclusiveGateway id="checkReviewDecision" name="Recommend?"/>

        <sequenceFlow id="flowRecommend" sourceRef="checkReviewDecision" targetRef="executiveApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'recommend'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowReviewReject" sourceRef="checkReviewDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Executive Approval -->
        <userTask id="executiveApproval" name="Executive Approval Required"
                  flowable:candidateGroups="executives"
                  flowable:formKey="expense-approval-form">
            <documentation>Final approval for high-value expense (Amount: $${amount})</documentation>
        </userTask>

        <sequenceFlow id="flow4" sourceRef="executiveApproval" targetRef="checkExecutiveDecision"/>

        <!-- Gateway: Check Executive Decision -->
        <exclusiveGateway id="checkExecutiveDecision" name="Executive Approved?"/>

        <sequenceFlow id="flowExecApproved" sourceRef="checkExecutiveDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExecRejected" sourceRef="checkExecutiveDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- End Events -->
        <endEvent id="endApproved" name="Expense Approved">
            <documentation>Expense has been approved</documentation>
        </endEvent>

        <endEvent id="endRejected" name="Expense Rejected">
            <documentation>Expense has been rejected</documentation>
        </endEvent>

    </process>
</definitions>
