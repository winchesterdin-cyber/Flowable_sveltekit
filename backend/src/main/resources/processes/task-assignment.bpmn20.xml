<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="task-assignment" name="Task Assignment" isExecutable="true">
        <documentation>Simple task assignment and completion workflow</documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Task Created">
            <documentation>A new task has been created</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="checkAssignment"/>

        <!-- Gateway: Check if pre-assigned -->
        <exclusiveGateway id="checkAssignment" name="Has Assignee?"/>

        <!-- Pre-assigned path -->
        <sequenceFlow id="flowAssigned" sourceRef="checkAssignment" targetRef="workOnTask">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${assignee != null && assignee != ''}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Unassigned path - needs claiming -->
        <sequenceFlow id="flowUnassigned" sourceRef="checkAssignment" targetRef="claimTask">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${assignee == null || assignee == ''}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Claim Task (for unassigned tasks) -->
        <userTask id="claimTask" name="Claim Task"
                  flowable:candidateGroups="users,supervisors,managers,directors,executives"
                  flowable:formKey="claim-task-form">
            <documentation>Task available for claiming: ${title}</documentation>
        </userTask>

        <sequenceFlow id="flow2" sourceRef="claimTask" targetRef="recordTaskClaimer"/>

        <!-- Script Task: Record who claimed the task -->
        <scriptTask id="recordTaskClaimer" name="Record Task Claimer"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                // The person who completed claimTask becomes the assignee for workOnTask
                var claimer = execution.getVariable('completedBy');
                if (claimer) {
                    execution.setVariable('assignee', claimer);
                }
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow2b" sourceRef="recordTaskClaimer" targetRef="workOnTask"/>

        <!-- User Task: Work on Task -->
        <userTask id="workOnTask" name="Complete Task"
                  flowable:assignee="${assignee}"
                  flowable:formKey="complete-task-form">
            <documentation>${title}: ${description}</documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="workOnTask" targetRef="endCompleted"/>

        <!-- End Event -->
        <endEvent id="endCompleted" name="Task Completed">
            <documentation>Task has been completed</documentation>
        </endEvent>

    </process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_task-assignment">
        <bpmndi:BPMNPlane id="BPMNPlane_task-assignment" bpmnElement="task-assignment">
            <!-- Start Event -->
            <bpmndi:BPMNShape id="startEvent_di" bpmnElement="startEvent">
                <dc:Bounds x="100" y="200" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="85" y="243" width="66" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Check Assignment Gateway -->
            <bpmndi:BPMNShape id="checkAssignment_di" bpmnElement="checkAssignment" isMarkerVisible="true">
                <dc:Bounds x="195" y="193" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="180" y="250" width="80" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Claim Task -->
            <bpmndi:BPMNShape id="claimTask_di" bpmnElement="claimTask">
                <dc:Bounds x="320" y="100" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Record Task Claimer -->
            <bpmndi:BPMNShape id="recordTaskClaimer_di" bpmnElement="recordTaskClaimer">
                <dc:Bounds x="480" y="100" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Work on Task -->
            <bpmndi:BPMNShape id="workOnTask_di" bpmnElement="workOnTask">
                <dc:Bounds x="480" y="270" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- End Completed -->
            <bpmndi:BPMNShape id="endCompleted_di" bpmnElement="endCompleted">
                <dc:Bounds x="662" y="292" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="637" y="335" width="86" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Sequence Flows -->
            <bpmndi:BPMNEdge id="flow1_di" bpmnElement="flow1">
                <di:waypoint x="136" y="218"/>
                <di:waypoint x="195" y="218"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowAssigned_di" bpmnElement="flowAssigned">
                <di:waypoint x="220" y="243"/>
                <di:waypoint x="220" y="310"/>
                <di:waypoint x="480" y="310"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="295" y="292" width="65" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowUnassigned_di" bpmnElement="flowUnassigned">
                <di:waypoint x="220" y="193"/>
                <di:waypoint x="220" y="140"/>
                <di:waypoint x="320" y="140"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="235" y="122" width="60" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow2_di" bpmnElement="flow2">
                <di:waypoint x="420" y="140"/>
                <di:waypoint x="480" y="140"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow2b_di" bpmnElement="flow2b">
                <di:waypoint x="530" y="180"/>
                <di:waypoint x="530" y="270"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow3_di" bpmnElement="flow3">
                <di:waypoint x="580" y="310"/>
                <di:waypoint x="662" y="310"/>
            </bpmndi:BPMNEdge>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</definitions>
