<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="leave-request" name="Leave Request" isExecutable="true">
        <documentation>Sequential leave request approval workflow</documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Leave Requested">
            <documentation>Employee submits leave request</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="supervisorApproval"/>

        <!-- User Task: Supervisor Approval -->
        <userTask id="supervisorApproval" name="Review Leave Request"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="leave-approval-form">
            <documentation>Review leave request: ${leaveType} from ${startDate} to ${endDate} (${days} days)</documentation>
        </userTask>

        <sequenceFlow id="flow2" sourceRef="supervisorApproval" targetRef="checkSupervisorDecision"/>

        <!-- Gateway: Check Supervisor Decision -->
        <exclusiveGateway id="checkSupervisorDecision" name="Supervisor Decision"/>

        <!-- Approved and short leave -->
        <sequenceFlow id="flowShortApproved" sourceRef="checkSupervisorDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved' && days <= 5}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Approved but long leave - needs executive -->
        <sequenceFlow id="flowLongApproved" sourceRef="checkSupervisorDecision" targetRef="executiveApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved' && days > 5}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Escalated to executive -->
        <sequenceFlow id="flowEscalated" sourceRef="checkSupervisorDecision" targetRef="executiveApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Rejected -->
        <sequenceFlow id="flowRejected" sourceRef="checkSupervisorDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Executive Approval -->
        <userTask id="executiveApproval" name="Executive Leave Approval"
                  flowable:candidateGroups="executives"
                  flowable:formKey="leave-approval-form">
            <documentation>Final approval for extended leave: ${leaveType} from ${startDate} to ${endDate} (${days} days)</documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="executiveApproval" targetRef="checkExecutiveDecision"/>

        <!-- Gateway: Check Executive Decision -->
        <exclusiveGateway id="checkExecutiveDecision" name="Executive Decision"/>

        <sequenceFlow id="flowExecApproved" sourceRef="checkExecutiveDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExecRejected" sourceRef="checkExecutiveDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- End Events -->
        <endEvent id="endApproved" name="Leave Approved">
            <documentation>Leave request has been approved</documentation>
        </endEvent>

        <endEvent id="endRejected" name="Leave Rejected">
            <documentation>Leave request has been rejected</documentation>
        </endEvent>

    </process>

    <bpmndi:BPMNDiagram id="BPMNDiagram_leave-request">
        <bpmndi:BPMNPlane id="BPMNPlane_leave-request" bpmnElement="leave-request">
            <!-- Start Event -->
            <bpmndi:BPMNShape id="startEvent_di" bpmnElement="startEvent">
                <dc:Bounds x="100" y="200" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="78" y="243" width="80" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Supervisor Approval -->
            <bpmndi:BPMNShape id="supervisorApproval_di" bpmnElement="supervisorApproval">
                <dc:Bounds x="200" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Check Supervisor Decision Gateway -->
            <bpmndi:BPMNShape id="checkSupervisorDecision_di" bpmnElement="checkSupervisorDecision" isMarkerVisible="true">
                <dc:Bounds x="365" y="193" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="350" y="250" width="80" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Executive Approval -->
            <bpmndi:BPMNShape id="executiveApproval_di" bpmnElement="executiveApproval">
                <dc:Bounds x="500" y="80" width="100" height="80"/>
            </bpmndi:BPMNShape>

            <!-- Check Executive Decision Gateway -->
            <bpmndi:BPMNShape id="checkExecutiveDecision_di" bpmnElement="checkExecutiveDecision" isMarkerVisible="true">
                <dc:Bounds x="665" y="95" width="50" height="50"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="648" y="152" width="85" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- End Approved -->
            <bpmndi:BPMNShape id="endApproved_di" bpmnElement="endApproved">
                <dc:Bounds x="800" y="200" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="778" y="243" width="80" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- End Rejected -->
            <bpmndi:BPMNShape id="endRejected_di" bpmnElement="endRejected">
                <dc:Bounds x="800" y="320" width="36" height="36"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="778" y="363" width="80" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNShape>

            <!-- Sequence Flows -->
            <bpmndi:BPMNEdge id="flow1_di" bpmnElement="flow1">
                <di:waypoint x="136" y="218"/>
                <di:waypoint x="200" y="218"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow2_di" bpmnElement="flow2">
                <di:waypoint x="300" y="218"/>
                <di:waypoint x="365" y="218"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowShortApproved_di" bpmnElement="flowShortApproved">
                <di:waypoint x="415" y="218"/>
                <di:waypoint x="800" y="218"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="580" y="200" width="55" height="27"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowLongApproved_di" bpmnElement="flowLongApproved">
                <di:waypoint x="390" y="193"/>
                <di:waypoint x="390" y="120"/>
                <di:waypoint x="500" y="120"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="405" y="103" width="70" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowEscalated_di" bpmnElement="flowEscalated">
                <di:waypoint x="390" y="193"/>
                <di:waypoint x="390" y="60"/>
                <di:waypoint x="550" y="60"/>
                <di:waypoint x="550" y="80"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="440" y="43" width="45" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowRejected_di" bpmnElement="flowRejected">
                <di:waypoint x="390" y="243"/>
                <di:waypoint x="390" y="338"/>
                <di:waypoint x="800" y="338"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="550" y="320" width="45" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flow3_di" bpmnElement="flow3">
                <di:waypoint x="600" y="120"/>
                <di:waypoint x="665" y="120"/>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowExecApproved_di" bpmnElement="flowExecApproved">
                <di:waypoint x="715" y="120"/>
                <di:waypoint x="818" y="120"/>
                <di:waypoint x="818" y="200"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="740" y="103" width="50" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>

            <bpmndi:BPMNEdge id="flowExecRejected_di" bpmnElement="flowExecRejected">
                <di:waypoint x="690" y="145"/>
                <di:waypoint x="690" y="338"/>
                <di:waypoint x="800" y="338"/>
                <bpmndi:BPMNLabel>
                    <dc:Bounds x="695" y="238" width="45" height="14"/>
                </bpmndi:BPMNLabel>
            </bpmndi:BPMNEdge>
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
</definitions>
