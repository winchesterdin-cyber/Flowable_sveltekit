<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://demo.com/bpm"
             xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL
                                 http://www.omg.org/spec/BPMN/20100524/MODEL/BPMN20.xsd">

    <process id="project-approval" name="Project Approval - Multi-Stakeholder" isExecutable="true">
        <documentation>
            Project approval workflow requiring sign-off from multiple stakeholders.
            Demonstrates parallel approval paths, handoffs, and final completion
            only after all required stakeholders have approved.
        </documentation>

        <!-- Start Event -->
        <startEvent id="startEvent" name="Project Proposal Submitted">
            <documentation>New project proposal submitted for approval</documentation>
        </startEvent>

        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="initializeProject"/>

        <!-- Service Task: Initialize Project -->
        <scriptTask id="initializeProject" name="Initialize Project Workflow"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                var budget = execution.getVariable('budget') || 0;
                var department = execution.getVariable('department') || 'General';
                var projectType = execution.getVariable('projectType') || 'standard';

                // Initialize approval tracking
                execution.setVariable('technicalApproved', false);
                execution.setVariable('financialApproved', false);
                execution.setVariable('legalApproved', false);
                execution.setVariable('executiveApproved', false);

                // Track who approved what
                execution.setVariable('technicalApprover', '');
                execution.setVariable('financialApprover', '');
                execution.setVariable('legalApprover', '');
                execution.setVariable('executiveApprover', '');

                // Determine required approvals based on project size
                var requiresLegal = budget > 25000 || projectType == 'legal' || projectType == 'compliance';
                var requiresExecutive = budget > 100000;

                execution.setVariable('requiresLegal', requiresLegal);
                execution.setVariable('requiresExecutive', requiresExecutive);
                execution.setVariable('currentPhase', 'PARALLEL_REVIEW');
                execution.setVariable('escalationHistory', '[]');
                execution.setVariable('handoffHistory', '[]');
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flow2" sourceRef="initializeProject" targetRef="parallelReviewStart"/>

        <!-- Parallel Gateway: Start Parallel Review -->
        <parallelGateway id="parallelReviewStart" name="Start Parallel Reviews"/>

        <sequenceFlow id="flowToTechnical" sourceRef="parallelReviewStart" targetRef="technicalReview"/>
        <sequenceFlow id="flowToFinancial" sourceRef="parallelReviewStart" targetRef="financialReview"/>
        <sequenceFlow id="flowToLegal" sourceRef="parallelReviewStart" targetRef="checkLegalRequired"/>

        <!-- User Task: Technical Review -->
        <userTask id="technicalReview" name="Technical Review"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="project-technical-review">
            <documentation>
                Review technical feasibility of project: ${projectName}.
                Budget: $${budget}. Timeline: ${timeline}.
                Assess technical requirements, resources, and risks.
                Actions: Approve, Reject, Request Changes, Escalate to Manager.
            </documentation>
        </userTask>

        <sequenceFlow id="flow3" sourceRef="technicalReview" targetRef="checkTechnicalDecision"/>

        <!-- Gateway: Check Technical Decision -->
        <exclusiveGateway id="checkTechnicalDecision" name="Technical Decision"/>

        <sequenceFlow id="flowTechApproved" sourceRef="checkTechnicalDecision" targetRef="recordTechnicalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowTechRejected" sourceRef="checkTechnicalDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowTechEscalate" sourceRef="checkTechnicalDecision" targetRef="technicalManagerReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowTechRequestChanges" sourceRef="checkTechnicalDecision" targetRef="addressTechnicalChanges">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Address Technical Changes -->
        <userTask id="addressTechnicalChanges" name="Address Technical Feedback"
                  flowable:assignee="${initiator}"
                  flowable:formKey="project-revision-form">
            <documentation>Address technical feedback: ${technicalFeedback}</documentation>
        </userTask>

        <sequenceFlow id="flowTechChangesAddressed" sourceRef="addressTechnicalChanges" targetRef="technicalReview"/>

        <!-- User Task: Technical Manager Review (Escalation) -->
        <userTask id="technicalManagerReview" name="Technical Manager Review"
                  flowable:candidateGroups="managers"
                  flowable:formKey="project-technical-review">
            <documentation>
                Escalated Technical Review for: ${projectName}.
                Escalation Reason: ${escalationReason}.
                Actions: Approve, Reject, De-escalate.
            </documentation>
        </userTask>

        <sequenceFlow id="flow4" sourceRef="technicalManagerReview" targetRef="checkTechMgrDecision"/>

        <exclusiveGateway id="checkTechMgrDecision" name="Tech Manager Decision"/>

        <sequenceFlow id="flowTechMgrApproved" sourceRef="checkTechMgrDecision" targetRef="recordTechnicalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowTechMgrRejected" sourceRef="checkTechMgrDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowTechMgrDeEscalate" sourceRef="checkTechMgrDecision" targetRef="technicalReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'de_escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Record Technical Approval -->
        <scriptTask id="recordTechnicalApproval" name="Record Technical Approval"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('technicalApproved', true);
                var approver = execution.getVariable('completedBy') || 'unknown';
                execution.setVariable('technicalApprover', approver);
                execution.setVariable('technicalApprovalTime', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowTechDone" sourceRef="recordTechnicalApproval" targetRef="parallelReviewEnd"/>

        <!-- User Task: Financial Review -->
        <userTask id="financialReview" name="Financial Review"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="project-financial-review">
            <documentation>
                Review financial aspects of project: ${projectName}.
                Budget: $${budget}. ROI Expected: ${expectedROI}.
                Assess budget allocation, cost-benefit, and financial risks.
                Actions: Approve, Reject, Request Changes, Escalate to Finance Manager.
            </documentation>
        </userTask>

        <sequenceFlow id="flow5" sourceRef="financialReview" targetRef="checkFinancialDecision"/>

        <!-- Gateway: Check Financial Decision -->
        <exclusiveGateway id="checkFinancialDecision" name="Financial Decision"/>

        <sequenceFlow id="flowFinApproved" sourceRef="checkFinancialDecision" targetRef="recordFinancialApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinRejected" sourceRef="checkFinancialDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinEscalate" sourceRef="checkFinancialDecision" targetRef="financeManagerReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinRequestChanges" sourceRef="checkFinancialDecision" targetRef="addressFinancialChanges">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Address Financial Changes -->
        <userTask id="addressFinancialChanges" name="Address Financial Feedback"
                  flowable:assignee="${initiator}"
                  flowable:formKey="project-revision-form">
            <documentation>Address financial feedback: ${financialFeedback}</documentation>
        </userTask>

        <sequenceFlow id="flowFinChangesAddressed" sourceRef="addressFinancialChanges" targetRef="financialReview"/>

        <!-- User Task: Finance Manager Review (Escalation) -->
        <userTask id="financeManagerReview" name="Finance Manager Review"
                  flowable:candidateGroups="managers"
                  flowable:formKey="project-financial-review">
            <documentation>
                Escalated Financial Review for: ${projectName}.
                Escalation Reason: ${escalationReason}.
                Actions: Approve, Reject, De-escalate.
            </documentation>
        </userTask>

        <sequenceFlow id="flow6" sourceRef="financeManagerReview" targetRef="checkFinMgrDecision"/>

        <exclusiveGateway id="checkFinMgrDecision" name="Finance Manager Decision"/>

        <sequenceFlow id="flowFinMgrApproved" sourceRef="checkFinMgrDecision" targetRef="recordFinancialApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinMgrRejected" sourceRef="checkFinMgrDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowFinMgrDeEscalate" sourceRef="checkFinMgrDecision" targetRef="financialReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'de_escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Record Financial Approval -->
        <scriptTask id="recordFinancialApproval" name="Record Financial Approval"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('financialApproved', true);
                var approver = execution.getVariable('completedBy') || 'unknown';
                execution.setVariable('financialApprover', approver);
                execution.setVariable('financialApprovalTime', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowFinDone" sourceRef="recordFinancialApproval" targetRef="parallelReviewEnd"/>

        <!-- Check if Legal Required -->
        <exclusiveGateway id="checkLegalRequired" name="Legal Required?"/>

        <sequenceFlow id="flowLegalRequired" sourceRef="checkLegalRequired" targetRef="legalReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresLegal == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalNotRequired" sourceRef="checkLegalRequired" targetRef="skipLegalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresLegal == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Skip Legal -->
        <scriptTask id="skipLegalApproval" name="Skip Legal (Not Required)"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('legalApproved', true);
                execution.setVariable('legalApprover', 'N/A - Not Required');
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowLegalSkipped" sourceRef="skipLegalApproval" targetRef="parallelReviewEnd"/>

        <!-- User Task: Legal Review -->
        <userTask id="legalReview" name="Legal Review"
                  flowable:candidateGroups="supervisors"
                  flowable:formKey="project-legal-review">
            <documentation>
                Review legal and compliance aspects of project: ${projectName}.
                Budget: $${budget}. Project Type: ${projectType}.
                Assess contracts, regulations, and legal risks.
                Actions: Approve, Reject, Request Changes, Escalate to Legal Director.
            </documentation>
        </userTask>

        <sequenceFlow id="flow7" sourceRef="legalReview" targetRef="checkLegalDecision"/>

        <!-- Gateway: Check Legal Decision -->
        <exclusiveGateway id="checkLegalDecision" name="Legal Decision"/>

        <sequenceFlow id="flowLegalApproved" sourceRef="checkLegalDecision" targetRef="recordLegalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalRejected" sourceRef="checkLegalDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalEscalate" sourceRef="checkLegalDecision" targetRef="legalDirectorReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalRequestChanges" sourceRef="checkLegalDecision" targetRef="addressLegalChanges">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'request_changes'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Address Legal Changes -->
        <userTask id="addressLegalChanges" name="Address Legal Feedback"
                  flowable:assignee="${initiator}"
                  flowable:formKey="project-revision-form">
            <documentation>Address legal feedback: ${legalFeedback}</documentation>
        </userTask>

        <sequenceFlow id="flowLegalChangesAddressed" sourceRef="addressLegalChanges" targetRef="legalReview"/>

        <!-- User Task: Legal Director Review (Escalation) -->
        <userTask id="legalDirectorReview" name="Legal Director Review"
                  flowable:candidateGroups="directors"
                  flowable:formKey="project-legal-review">
            <documentation>
                Escalated Legal Review for: ${projectName}.
                Escalation Reason: ${escalationReason}.
                Actions: Approve, Reject, De-escalate.
            </documentation>
        </userTask>

        <sequenceFlow id="flow8" sourceRef="legalDirectorReview" targetRef="checkLegalDirDecision"/>

        <exclusiveGateway id="checkLegalDirDecision" name="Legal Director Decision"/>

        <sequenceFlow id="flowLegalDirApproved" sourceRef="checkLegalDirDecision" targetRef="recordLegalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalDirRejected" sourceRef="checkLegalDirDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowLegalDirDeEscalate" sourceRef="checkLegalDirDecision" targetRef="legalReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'de_escalate'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Record Legal Approval -->
        <scriptTask id="recordLegalApproval" name="Record Legal Approval"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                execution.setVariable('legalApproved', true);
                var approver = execution.getVariable('completedBy') || 'unknown';
                execution.setVariable('legalApprover', approver);
                execution.setVariable('legalApprovalTime', new Date().toISOString());
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowLegalDone" sourceRef="recordLegalApproval" targetRef="parallelReviewEnd"/>

        <!-- Parallel Gateway: End Parallel Review -->
        <parallelGateway id="parallelReviewEnd" name="All Reviews Complete"/>

        <sequenceFlow id="flow9" sourceRef="parallelReviewEnd" targetRef="checkExecutiveRequired"/>

        <!-- Check if Executive Approval Required -->
        <exclusiveGateway id="checkExecutiveRequired" name="Executive Required?"/>

        <sequenceFlow id="flowExecRequired" sourceRef="checkExecutiveRequired" targetRef="executiveFinalApproval">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresExecutive == true}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExecNotRequired" sourceRef="checkExecutiveRequired" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${requiresExecutive == false}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- User Task: Executive Final Approval -->
        <userTask id="executiveFinalApproval" name="Executive Final Approval"
                  flowable:candidateGroups="executives"
                  flowable:formKey="project-executive-approval">
            <documentation>
                FINAL EXECUTIVE APPROVAL for project: ${projectName}.
                Budget: $${budget}. Timeline: ${timeline}.

                All preliminary approvals received:
                - Technical: ${technicalApprover}
                - Financial: ${financialApprover}
                - Legal: ${legalApprover}

                Actions: Approve (Final), Reject, Send Back for Review.
            </documentation>
        </userTask>

        <sequenceFlow id="flow10" sourceRef="executiveFinalApproval" targetRef="checkExecFinalDecision"/>

        <!-- Gateway: Check Executive Final Decision -->
        <exclusiveGateway id="checkExecFinalDecision" name="Executive Final Decision"/>

        <sequenceFlow id="flowExecFinalApproved" sourceRef="checkExecFinalDecision" targetRef="endApproved">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'approved'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExecFinalRejected" sourceRef="checkExecFinalDecision" targetRef="endRejected">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'rejected'}]]>
            </conditionExpression>
        </sequenceFlow>

        <sequenceFlow id="flowExecSendBack" sourceRef="checkExecFinalDecision" targetRef="resetForReview">
            <conditionExpression xsi:type="tFormalExpression">
                <![CDATA[${decision == 'send_back'}]]>
            </conditionExpression>
        </sequenceFlow>

        <!-- Script Task: Reset for Review -->
        <scriptTask id="resetForReview" name="Reset for New Review Cycle"
                    scriptFormat="javascript" flowable:autoStoreVariables="true">
            <script>
                <![CDATA[
                // Reset all approvals for a new review cycle
                execution.setVariable('technicalApproved', false);
                execution.setVariable('financialApproved', false);
                execution.setVariable('legalApproved', false);
                execution.setVariable('reviewCycle', (execution.getVariable('reviewCycle') || 0) + 1);
                ]]>
            </script>
        </scriptTask>

        <sequenceFlow id="flowResetDone" sourceRef="resetForReview" targetRef="parallelReviewStart"/>

        <!-- End Events -->
        <endEvent id="endApproved" name="Project Approved">
            <documentation>
                Project has been fully approved by all required stakeholders.
                Technical: ${technicalApprover}
                Financial: ${financialApprover}
                Legal: ${legalApprover}
                Executive: ${executiveApprover}
            </documentation>
        </endEvent>

        <endEvent id="endRejected" name="Project Rejected">
            <documentation>Project has been rejected</documentation>
        </endEvent>

    </process>
</definitions>
